{
    "session_dir": "pretrained",
    "initialize": {
        "definitions": {
            "data": [
                {
                    "group": "preprocessors",
                    "name": "tokenize",
                    "spec": {
                        "class": "examples.htr_self_training.preprocessors.CharacterTokenizer",
                        "kwargs": {
                            "charset": "english"
                        }
                    }
                },
                {
                    "group": "datasets",
                    "name": "synthetic_train",
                    "spec": {
                        "class": "examples.htr_self_training.datasets.SyntheticDataset",
                        "args": ["examples/htr_self_training/synthetic_data/train"],
                        "preprocessors": ["", "tokenize"]
                    }
                },
                {
                    "group": "datasets",
                    "name": "synthetic_val",
                    "spec": {
                        "class": "examples.htr_self_training.datasets.SyntheticDataset",
                        "args": ["examples/htr_self_training/synthetic_data/val"],
                        "preprocessors": ["", "tokenize"]
                    }
                },
                {
                    "group": "datasets",
                    "name": "unlabeled",
                    "spec": {
                        "class": "examples.htr_self_training.datasets.UnlabeledDataset",
                        "args": ["examples/htr_self_training/iam/iam_train.txt"]
                    }
                },
                {
                    "group": "datasets",
                    "name": "pseudo_labeled",
                    "spec": {
                        "class": "examples.htr_self_training.datasets.LabeledDataset",
                        "args": ["examples/htr_self_training/iam/pseudo_labels.txt"],
                        "preprocessors": ["", "tokenize"]
                    }
                },
                {
                    "group": "datasets",
                    "name": "iam_test_dataset",
                    "spec": {
                        "class": "examples.htr_self_training.datasets.LabeledDataset",
                        "args": ["examples/htr_self_training/iam/iam_val.txt"],
                        "preprocessors": ["", "tokenize"]
                    }
                },
                {
                    "group": "datasets",
                    "name": "unlabeled_impostor",
                    "spec": {
                        "class": "examples.htr_self_training.datasets.UnlabeledImpostorDataset",
                        "args": ["examples/htr_self_training/synthetic_data/train"]
                    }
                },
                {
                    "group": "collators",
                    "name": "unpack_batch",
                    "spec": {
                        "class": "torchassistant.collators.BatchDivide"
                    }
                },
                {
                    "group": "data_loaders",
                    "name": "synthetic_train_loader",
                    "spec": {
                        "dataset": "synthetic_train",
                        "collator": "unpack_batch",
                        "kwargs": {
                            "batch_size": 4
                        }
                    }
                },
                {
                    "group": "data_loaders",
                    "name": "synthetic_val_loader",
                    "spec": {
                        "dataset": "synthetic_val",
                        "collator": "unpack_batch",
                        "kwargs": {
                            "batch_size": 4
                        }
                    }
                },
                {
                    "group": "data_loaders",
                    "name": "unlabeled_loader",
                    "spec": {
                        "dataset": "unlabeled",
                        "collator": "unpack_batch",
                        "kwargs": {
                            "batch_size": 4
                        }
                    }
                },
                {
                    "group": "data_loaders",
                    "name": "pseudo_labeled_loader",
                    "spec": {
                        "dataset": "pseudo_labeled",
                        "collator": "unpack_batch",
                        "kwargs": {
                            "batch_size": 4
                        }
                    }
                },
                {
                    "group": "data_loaders",
                    "name": "test_loader",
                    "spec": {
                        "dataset": "iam_test_dataset",
                        "collator": "unpack_batch",
                        "kwargs": {
                            "batch_size": 4
                        }
                    }
                },
                {
                    "group": "data_loaders",
                    "name": "unlabeled_impostor_loader",
                    "spec": {
                        "dataset": "unlabeled_impostor",
                        "collator": "unpack_batch",
                        "kwargs": {
                            "batch_size": 4
                        }
                    }
                }
            ],
            "computation": [
                {
                    "group": "models",
                    "name": "encoder",
                    "spec": {
                        "factory_fn": "examples.htr_self_training.models.build_encoder",
                        "kwargs": {
                            "image_height": 64,
                            "hidden_size": 32
                        }
                    }
                },
                {
                    "group": "models",
                    "name": "decoder",
                    "spec": {
                        "factory_fn": "examples.htr_self_training.models.build_decoder"
                    }
                },
                {
                    "group": "optimizers",
                    "name": "encoder_optimizer",
                    "spec": {
                        "class": "Adam",
                        "kwargs": {
                            "lr": 0.001
                        },
                        "model": "encoder"
                    }
                },
                {
                    "group": "optimizers",
                    "name": "decoder_optimizer",
                    "spec": {
                        "class": "Adam",
                        "kwargs": {
                            "lr": 0.001
                        },
                        "model": "decoder"
                    }
                },
                {
                    "group": "losses",
                    "name": "cross_entropy",
                    "spec": {
                        "class": "torchassistant.loss_functions.MaskedCrossEntropy",
                        "inputs": ["y_hat", "y"],
                        "transform": "torchassistant.transforms.pad_targets"
                    }
                },
                {
                    "group": "losses",
                    "name": "consistency_loss",
                    "spec": {
                        "class": "examples.htr_self_training.ConsistencyLoss",
                        "inputs": ["y_hat_weak", "y_hat_strong", "y"],
                        "transform": "examples.htr_self_training.transforms.pad_targets"
                    }
                },
                {
                    "group": "metrics",
                    "name": "cer",
                    "spec": {
                        "class": "CharErrorRate",
                        "inputs": ["y_hat", "y"],
                        "transform": "examples.htr_self_training.preprocessors.DecodeCharacterString"
                    }
                },
                {
                    "group": "metrics",
                    "name": "wer",
                    "spec": {
                        "class": "WordErrorRate",
                        "inputs": ["y_hat", "y"],
                        "transform": "examples.htr_self_training.preprocessors.DecodeCharacterString"
                    }
                },
                {
                    "group": "batch_processors",
                    "name": "evaluation_processor",
                    "spec": {
                        "input_adapter": {
                            "factory_fn": "examples.htr_self_training.adapters.build_evaluation_input_adapter"
                        },
                        "neural_graph": [
                            {
                                "model_name": "encoder",
                                "inputs": ["x"],
                                "outputs": ["encodings", "h_e"],
                                "optimizer_name": "encoder_optimizer"
                            },
                            {
                                "model_name": "decoder",
                                "inputs": ["encodings", "tf_seq"],
                                "outputs": ["y_hat", "h_d"],
                                "optimizer_name": "decoder_optimizer"
                            }
                        ],
                        "output_adapter": {
                            "class": "examples.htr_self_training.adapters.BaseOutputAdapter"
                        }
                    }
                },
                {
                    "group": "batch_processors",
                    "name": "synth_trainable_processor",
                    "spec": {
                        "input_adapter": {
                            "factory_fn": "examples.htr_self_training.adapters.build_synthetic_image_input_adapter"
                        },
                        "neural_graph": [
                            {
                                "model_name": "encoder",
                                "inputs": ["x"],
                                "outputs": ["encodings", "h_e"],
                                "optimizer_name": "encoder_optimizer"
                            },
                            {
                                "model_name": "decoder",
                                "inputs": ["encodings", "tf_seq"],
                                "outputs": ["y_hat", "h_d"],
                                "optimizer_name": "decoder_optimizer"
                            }
                        ],
                        "output_adapter": {
                            "class": "examples.htr_self_training.adapters.BaseOutputAdapter"
                        }
                    }
                }, {
                    "group": "batch_processors",
                    "name": "label_predicting_processor",
                    "spec": {
                        "input_adapter": {
                            "factory_fn": "examples.htr_self_training.adapters.build_predictor_input_adapter"
                        },
                        "neural_graph": [
                            {
                                "model_name": "encoder",
                                "inputs": ["x"],
                                "outputs": ["encodings", "h_e"],
                                "optimizer_name": "encoder_optimizer"
                            },
                            {
                                "model_name": "decoder",
                                "inputs": ["encodings"],
                                "outputs": ["y_hat", "h_d"],
                                "optimizer_name": "decoder_optimizer"
                            }
                        ],
                        "output_adapter": {
                            "factory_fn": "examples.htr_self_training.adapters.build_prediction_output_adapter",
                            "kwargs": {
                                "pseudo_labels_path": "examples/htr_self_training/iam/pseudo_labels.txt",
                                "threshold": 0.4
                            }
                        }
                    }
                },
                {
                    "group": "batch_processors",
                    "name": "labeled_image_processor",
                    "spec": {
                        "input_adapter": {
                            "factory_fn": "examples.htr_self_training.adapters.build_augmentation_adapter"
                        },
                        "neural_graph": [
                            {
                                "model_name": "encoder",
                                "inputs": ["x_weak"],
                                "outputs": ["encodings_weak", "h_e_weak"],
                                "optimizer_name": "encoder_optimizer",
                                "alias": "encoder_weak"
                            },
                            {
                                "model_name": "decoder",
                                "inputs": ["encodings_weak", "tf_seq"],
                                "outputs": ["y_hat_weak", "h_d_weak"],
                                "optimizer_name": "decoder_optimizer",
                                "alias": "decoder_weak"
                            },
                            {
                                "model_name": "encoder",
                                "inputs": ["x_strong"],
                                "outputs": ["encodings_strong", "h_e_strong"],
                                "optimizer_name": "encoder_optimizer",
                                "alias": "encoder_strong"
                            },
                            {
                                "model_name": "decoder",
                                "inputs": ["encodings_strong", "tf_seq"],
                                "outputs": ["y_hat_strong", "h_d_strong"],
                                "optimizer_name": "decoder_optimizer",
                                "alias": "decoder_strong"
                            }
                        ],
                        "output_adapter": {
                            "class": "examples.htr_self_training.adapters.BaseOutputAdapter"
                        }
                    }
                },
                {
                    "group": "batch_graphs",
                    "name": "synth_training_graph",
                    "spec": {
                        "nodes": ["synth_trainable_processor"],
                        "input_ports": ["default_port"],
                        "ingoing_edges": {
                            "synth_trainable_processor": ["default_port"]
                        }
                    }
                },
                {
                    "group": "batch_graphs",
                    "name": "label_prediction_graph",
                    "spec": {
                        "nodes": ["label_predicting_processor"],
                        "input_ports": ["default_port"],
                        "ingoing_edges": {
                            "label_predicting_processor": ["default_port"]
                        }
                    }
                },
                {
                    "group": "batch_graphs",
                    "name": "real_data_training_graph",
                    "spec": {
                        "nodes": ["labeled_image_processor"],
                        "input_ports": ["default_port"],
                        "ingoing_edges": {
                            "labeled_image_processor": ["default_port"]
                        }
                    }
                },
                {
                    "group": "batch_graphs",
                    "name": "evaluation_without_validation_graph",
                    "spec": {
                        "nodes": ["evaluation_processor"],
                        "input_ports": ["default_port"],
                        "ingoing_edges": {
                            "evaluation_processor": ["default_port"]
                        }
                    }
                }
            ],
            "callbacks": [{
                "group": "callbacks",
                "name": "erase_pseudo_labels",
                "spec": {
                    "class": "examples.htr_self_training.callbacks.ErasePseudoLabels",
                    "kwargs": {
                        "pseudo_labels_path": "examples/htr_self_training/iam/pseudo_labels.txt"
                    }
                }
            }, {
                "group": "callbacks",
                "name": "rebuild_index",
                "spec": {
                    "class": "examples.htr_self_training.callbacks.RebuildIndex"
                }
            }]
        },
        "pipelines": {
             "fit_synthetic": {
                 "graph": "synth_training_graph",
                 "input_injector": [
                     {
                         "data_loader": "synthetic_train_loader"
                     }
                 ],
                 "losses": [
                     {
                         "node_name": "synth_trainable_processor",
                         "loss_name": "cross_entropy",
                         "loss_display_name": "synth loss"
                     }
                 ],
                 "metrics": [
                     {
                         "node_name": "synth_trainable_processor",
                         "metric_name": "cer"
                     },
                     {
                         "node_name": "synth_trainable_processor",
                         "metric_name": "wer"
                     }
                 ]
            },
            "evaluate_on_synthetic": {
                 "graph": "evaluation_without_validation_graph",
                 "input_injector": [
                     {
                         "data_loader": "synthetic_val_loader"
                     }
                 ],
                 "losses": [
                     {
                         "node_name": "evaluation_processor",
                         "loss_name": "cross_entropy",
                         "loss_display_name": "val synth loss"
                     }
                 ],
                 "metrics": [
                     {
                         "node_name": "evaluation_processor",
                         "metric_name": "cer",
                         "display_name": "val cer"
                     },
                     {
                         "node_name": "evaluation_processor",
                         "metric_name": "wer",
                         "display_name": "val wer"
                     }
                 ]
            },
            "predict_pseudo_labels": {
                "graph": "label_prediction_graph",
                "input_injector": [
                     {
                         "data_loader": "unlabeled_loader"
                     }
                 ]
            },
            "fit_pseudo_labeled": {
                "graph": "real_data_training_graph",
                "input_injector": [
                    {
                        "data_loader": "pseudo_labeled_loader"
                    }
                ],
                "losses": [
                    {
                        "node_name": "labeled_image_processor",
                        "loss_name": "consistency_loss",
                        "loss_display_name": "consistency loss"
                    }
                ],
                "metrics": []
            },
            "evaluate_on_iam": {
                "graph": "evaluation_without_validation_graph",
                "input_injector": [
                    {
                        "data_loader": "test_loader"
                    }
                ],
                "losses": [
                    {
                        "node_name": "evaluation_processor",
                        "loss_name": "cross_entropy",
                        "loss_display_name": "iam test loss"
                    }
                ],
                "metrics": [
                    {
                        "node_name": "evaluation_processor",
                        "metric_name": "cer",
                        "display_name": "iam test CER"
                    },
                    {
                        "node_name": "evaluation_processor",
                        "metric_name": "wer",
                        "display_name": "iam test WER"
                    }
                ]
            }
        }
    },
    "train": {
        "stages": [{
            "training_pipelines": [
                "fit_synthetic"
            ],
            "validation_pipelines": [
                "fit_synthetic", "evaluate_on_synthetic"
            ],
            "eval_steps": 0.1,
            "stop_condition": {
                "class": "torchassistant.stop_conditions.EpochsCompleted",
                "kwargs": {
                    "num_epochs": 1
                }
            }
        }, {
            "run_before_epoch": ["erase_pseudo_labels", "predict_pseudo_labels", "rebuild_index"],
            "training_pipelines": [
                "fit_pseudo_labeled"
            ],
            "validation_pipelines": [
                "fit_pseudo_labeled", "evaluate_on_iam"
            ],
            "eval_steps": 0.1,
            "stop_condition": {
                "class": "torchassistant.stop_conditions.EpochsCompleted",
                "kwargs": {
                    "num_epochs": 1
                }
            }
        }]
    }
}
